# eugenebbr_infra
eugenebbr Infra repository

***Задания с SSH***

Для подключения к серверу внутренней сети в одну команду из локального рабочего места, используя внешний сервер bastion-host, необходимо использовать следующий метод:

```
ssh -i <путь к ключу> -t -A <пользователь>@<внешний IP сервера bastion-host> ssh <IP конечного сервера внутренней сети>
```

Например:

```
ssh -i ~/.ssh/appuser -t -A appuser@34.76.5.251 ssh 10.132.0.5
```

Предварительно нужно добавить приватный ключ в ssh агент авторизации командой:

```
ssh-add <путь к ключу>
```

Для подключения к серверу внутренней сети по алиасу из локального рабочего места, сначала нужно создать алиас:

```
alias <имя алиаса>="<команда>"
```

Например:

```
alias someinternalhost="ssh -i ~/.ssh/appuser -t -A appuser@34.76.5.251 ssh 10.132.0.5"
```

Подключение осуществляется посредством ввода имени алиаса:

```
someinternalhost
```

***Задания с VPN***

Конфигурация ВМ следующая:

```
bastion_IP = 34.76.5.251
someinternalhost_IP = 10.132.0.5
```

Выполненные шаги:

- Развернут VPN сервер и БД, с использованием скрипта setupvpn.sh
- Создан VPN пользователь test
- Добавлен сертификат Let's Encrypt
- Веб-интерфейс доступен по адресу https://34.76.5.251.xip.io/


***Домашнее задание №6***
***Деплой тестового приложения***

Для деплоя тестового приложения было создано три скрипта:

1. Установка ruby, скрипт install_ruby.sh
2. Установка MongoDB, скрипт install_mongodb.sh
3. Установка и запуск приложения, скрипт deploy.sh

Для выполнения дополнительного задания был создан скрипт startup_script.sh, который разворачивает приложение при создании инстанса и включает функционал всех трех вышеприведенных скриптов.
Скрипт был добавлен в бакет, для публичного доступа к нему из интернет по URL.
Для выполнения задания по разворачиванию приложения при создании ВМ использована следующая команда:

```
gcloud compute instances create reddit-app --scopes storage-ro --metadata startup-script-url=https://storage.googleapis.com/eugbbr-bucket/startup_script.sh --boot-disk-size=10GB --image-family ubuntu-1604-lts --image-project=ubuntu-os-cloud --machine-type=g1-small --tags puma-server --restart-on-failure
```

Для выполнения дополнительного задания по изменению правила firewall из консоли была использована следующая команда:

```
gcloud compute firewall-rules create default-puma-server --allow=tcp:9292 --direction=INGRESS --target-tags=puma-server
```

Для проверки инстанса используется следующая конфигурация:

```
testapp_IP = 35.241.159.54
testapp_port = 9292
```

***Домашнее задание №7 Сборка образов VM при помощи Packer***

В ходе выполнения домашнего задания был создан Packer шаблон ubuntu16.json, собран образ ВМ с установленным Ruby и MongoDB.

Были параметризованы в Packer шаблоне и записаны в файл variables.json:

 - ID проекта
 - source_image_family
 - machine_type
 - zone
 - source_image

Были добавлены опции builder:

 - Описание образа
 - Размер и тип диска
 - Название сети
 - Теги

Для выполнения дополнительного задания по созданию образа со всеми зависимостями были созданы: шаблон immutable.json, файл переменных immutable-variables.json, скрипт запсука службы приложения start_puma.sh и сам файл службы puma-service.

Для выполнения дополнительного задания по созданию ВМ из образа с полностью готовым приложением, с помощью gcloud был создан скрипт create-reddit-vm.sh


***Домашнее задание №8 Практика IaC с использованием Terraform***

В ходе выполнения домашнего задания было настроено разворачивание нашего приложения с помощью Terraform.
Был создан главный конфигурационный файл main.tf, файл с переменными variables.tf, файл со значениями переменных terraform.tfvars и файл выходных данных outputs.tf

Для выполнения дополнительного задания со (*) были добавлены ssh ключи нескольких пользователей в метаданные проекта в коде терраформа.
Был добавлен ssh ключ пользователя appuser_web в метаданные проекта через веб-интерфейс, но после применения Terraform apply он был удален, поскольку мы должны использовать один метод добавления ключей - через веб или через Terraform.

Для выполнения дополнительного задания с (**) был создан файл lb.tf, создающий HTTP балансировщик на наше приложение. В output добавлена переменная адреса балансировщика.
Был добавлен код еще одного инстанса приложения, инстанс был добавлен в балансировщик. Было проверено, что при остановке приложения на одном из инстансов, оно все еще доступно по адресу балансировщика. В output было добавлена переменная адреса второго инстанса.
Проблемы такой конфигурации в том, что копируется много одного и того же кода, затрудняется читаемость.
Был использован подход с заданием количества инстансов через параметр ресурса count.

***Домашнее задание №9 Принципы организации инфраструктурного кода и работа над инфраструктурой в команде на примере Terraform***

В ходе выполнения домашнего задания с помощью Terraform было создано правило, разрешающее подключение по ssh. После применения правила возникла ошибка, потому что такое же правило уже существовало в нашем проекте, добавленное вручную. Правило было успешно добавлено через команду import.
Было создано два образа для деплоя ВМ с MongoDB и ВМ с установленным Ruby, а также три модуля: приложения, базы данных и модуль настройки правил фаервола. Все модули были параметризированы.
Было создано два окружения stage и prod, протестированы с различными параметрами доступа.
Успешно добавлен модуль из реестра модулей для создания бакета.

Для выполнения дополнительного задания со (*) было настроено хранение стейта окружений prod и stage на удаленном бекенде: сначала создан бакет через Terraform, затем туда перенесен стейт. Все настройки вынесены в файл backend.tf., локальные конфиги удалены, проверена работоспособность независимо от директории. При применении конфигураций одновременно Terraform создает блокировку.

Для выполнения дополнительного задания с (**) были добавлены провижинеры деплоя приложения, был запечен новый образ MongoDB с измененнными конфигом (вместо прослушивания 127.0.0.1 изменен на 0.0.0.0), для передачи приложению адреса БД из переменной окружения был использован темплейт.
